name: test Build and Release APK

on:
  workflow_dispatch:
  push:
    branches:
      - new

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download last SHA artifact
      uses: dawidd6/action-download-artifact@v6
      with:
        workflow: test.yml
        name: last-sha
        path: .
      continue-on-error: true

    - name: Get Commits Since Last Build
      run: |
        if [ -f last_sha.txt ]; then
          LAST_SHA=$(cat last_sha.txt)
        else
          LAST_SHA=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "Commits since $LAST_SHA:"
        COMMIT_LOGS=$(git log $LAST_SHA..HEAD --pretty=format:"‚óè %s ~%an [÷ç](https://github.com/${{ github.repository }}/commit/%H)" --max-count=10)
        COMMIT_LOGS=$(echo "$COMMIT_LOGS" | sed -E 's/#([0-9]+)/[#\1](https:\/\/github.com\/${{ github.repository }}\/pull\/\1)/g')
        
        # URL-encode for GitHub Actions
        COMMIT_LOGS="${COMMIT_LOGS//'%'/'%25'}"
        COMMIT_LOGS="${COMMIT_LOGS//$'\n'/'%0A'}"
        COMMIT_LOGS="${COMMIT_LOGS//$'\r'/'%0D'}"
        
        echo "COMMIT_LOG=${COMMIT_LOGS}" >> $GITHUB_ENV
        echo "$COMMIT_LOGS" > commit_log.txt
      continue-on-error: true

    - name: Save Current SHA for Next Build
      run: echo $(git rev-parse HEAD) > last_sha.txt

    - name: Set Version
      run: |
        VER=$(grep -E -o "versionName \".*\"" app/build.gradle | sed -e 's/versionName //g' | tr -d '"')
        SHA=$(git rev-parse HEAD)
        VERSION="$VER+${SHA:0:7}"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Building version: $VERSION"

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: 17
        cache: gradle

    - name: Decode Keystore File
      run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > $GITHUB_WORKSPACE/key.keystore

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build with Gradle
      run: |
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          ./gradlew assembleGoogleAlpha \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/key.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEYSTORE_PASSWORD }}
        else
          ./gradlew assembleGoogleAlpha
        fi

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Santotsu-APK
        retention-days: 5
        compression-level: 9
        path: "app/build/outputs/apk/google/alpha/*.apk"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "alpha-${{ env.VERSION }}"
        name: "Santotsu Alpha ‚Äì ${{ env.VERSION }}"
        body: |
          üöÄ **New Santotsu Alpha Build Released**

          **Version:** ${{ env.VERSION }}

          **Recent Commits:**
          ${{ env.COMMIT_LOG }}

          ‚ö†Ô∏è This is an **alpha build**. Expect bugs and issues.
          
          ---
          
          üì¶ Download the APK below and install on your Android device.
        files: |
          app/build/outputs/apk/google/alpha/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload SHA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: last-sha
        path: last_sha.txt

    - name: Upload Commit Log Artifact
      uses: actions/upload-artifact@v4
      with:
        name: commit-log
        path: commit_log.txt
